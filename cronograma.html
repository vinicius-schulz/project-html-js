<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cronograma do Projeto Google CCAI Platform</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    let tasks = [];

    google.charts.load('current', {
      'packages': ['gantt'],
      'language': 'pt-BR'
    });
    google.charts.setOnLoadCallback(drawChart);

    // Função para desenhar o gráfico de Gantt
    function drawChart() {
      if (tasks && tasks.length > 0) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Id da tarefa');
        data.addColumn('string', 'Nome da tarefa');
        data.addColumn('string', 'Recurso');
        data.addColumn('date', 'Data de Início');
        data.addColumn('date', 'Data Fim');
        data.addColumn('number', 'Duração');
        data.addColumn('number', 'Percentual completo');
        data.addColumn('string', 'Dependencias');

        tasks.forEach(task => {
          data.addRow([
            task.id,
            task.name,
            task.resource,
            new Date(task.start),
            new Date(task.end),
            null,
            task.percentComplete,
            task.dependencies ? task.dependencies : ''  // Substitui null ou undefined por string vazia
          ]);
        });

        var options = {
          height: 600,
          gantt: {
            trackHeight: 30
          }
        };

        var chart = new google.visualization.Gantt(document.getElementById('gantt_chart'));
        chart.draw(data, options);
      }
    }

    // Função para atualizar o gráfico quando os dados forem alterados
    function updateChart() {
      drawChart();
    }

    // Função para adicionar uma nova tarefa
    function addTask() {
      tasks.push({ id: '', name: '', resource: '', start: '', end: '', percentComplete: 0, dependencies: '' });
      renderTable();
      updateChart();
    }

    // Função para remover uma tarefa
    function deleteTask(index) {
      tasks.splice(index, 1);
      renderTable();
      updateChart();
    }

    // Função para renderizar a tabela de tarefas com arrastar e soltar
    function renderTable() {
      const tableBody = document.getElementById('task_table_body');
      tableBody.innerHTML = ''; // Limpa a tabela
      tasks.forEach((task, index) => {
        const row = `
            <tr draggable="true" ondragstart="dragStart(event, ${index})" ondragover="dragOver(event)" ondrop="drop(event, ${index})">
              <td><input type="text" value="${task.id}" onblur="updateTask(${index}, 'id', this.value)" /></td>
              <td><input type="text" value="${task.name}" onblur="updateTask(${index}, 'name', this.value)" /></td>
              <td><input type="text" value="${task.resource}" onblur="updateTask(${index}, 'resource', this.value)" /></td>
              <td><input type="date" value="${task.start}" onblur="updateTask(${index}, 'start', this.value)" /></td>
              <td><input type="date" value="${task.end}" onblur="updateTask(${index}, 'end', this.value)" /></td>
              <td><input type="number" value="${task.percentComplete}" onblur="updateTask(${index}, 'percentComplete', this.value)" /></td>
              <td><input type="text" value="${task.dependencies || ''}" onblur="updateTask(${index}, 'dependencies', this.value)" /></td>
              <td><button onclick="deleteTask(${index})">Excluir</button></td>
            </tr>
          `;
        tableBody.innerHTML += row;
      });
    }

    // Função para atualizar a tarefa conforme o input
    function updateTask(index, field, value) {
      tasks[index][field] = value;
      updateChart();
    }

    // Função para exportar o JSON
    function exportTasks() {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tasks, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", "tasks.json");
      document.body.appendChild(downloadAnchorNode); // Required for Firefox
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }

    // Função para importar o JSON
    function importTasks(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        tasks = JSON.parse(e.target.result);
        renderTable();
        updateChart();
      };
      reader.readAsText(file);
    }

    // Variável global para manter o índice do item que está sendo arrastado
    let draggedTaskIndex = null;

    // Função para iniciar o arraste de uma linha
    function dragStart(event, index) {
      draggedTaskIndex = index;
    }

    // Função para permitir que o item seja arrastado sobre outro
    function dragOver(event) {
      event.preventDefault(); // Necessário para permitir o drop
    }

    // Função para trocar a posição das tarefas ao soltar
    function drop(event, dropIndex) {
      event.preventDefault();
      if (draggedTaskIndex !== null) {
        const draggedTask = tasks[draggedTaskIndex];
        tasks.splice(draggedTaskIndex, 1); // Remove a tarefa arrastada da posição original
        tasks.splice(dropIndex, 0, draggedTask); // Insere a tarefa na nova posição
        draggedTaskIndex = null; // Reseta o índice
        renderTable(); // Re-renderiza a tabela
        updateChart(); // Atualiza o gráfico
      }
    }

    window.onload = function () {
      renderTable(); // Renderiza a tabela ao carregar a página
    }
  </script>
  <style>
    table input {
      width: 100%;
      /* Faz o input ocupar toda a largura da célula */
      box-sizing: border-box;
      /* Garante que o padding não ultrapasse a célula */
    }

    table {
      table-layout: auto;
      /* Permite redimensionamento das colunas */
      width: 100%;
    }

    th {
      resize: horizontal;
      /* Permite o redimensionamento horizontal das colunas */
      overflow: hidden;
      /* Esconde o conteúdo que ultrapassar */
    }

    tr[draggable="true"] {
      cursor: move;
    }
  </style>

</head>

<body>
  <h1>Cronograma Executivo - Implantação do Google CCAI Platform</h1>
  <div id="gantt_chart" style="width: 100%; height: 600px;"></div>

  <h2>Tarefas</h2>
  <button onclick="addTask()">Adicionar Tarefa</button>
  <button onclick="exportTasks()">Exportar JSON</button>
  <input type="file" id="fileInput" accept=".json" onchange="importTasks(event)" />

  <table style="width: 100%; margin-top: 10px;">
    <thead>
      <tr>
        <th>Id da tarefa</th>
        <th>Nome da tarefa</th>
        <th>Recurso</th>
        <th>Data de Início</th>
        <th>Data Fim</th>
        <th>Percentual completo</th>
        <th>Dependências</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="task_table_body"></tbody>
  </table>
</body>

</html>
